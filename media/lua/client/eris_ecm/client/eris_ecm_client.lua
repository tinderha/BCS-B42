----------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------
--
-- eris_ecm_client
--
--
----------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------

if isServer() then return; end;

----------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------

eris_ecm_client = {
	window = nil,
	packet = nil,
	lastPing = 0,
	panicState = false,
};

----------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------

eris_ecm_client.getPacket = function()
	return eris_ecm_client.packet;
end

----------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------

eris_ecm_client.ping = function()
	local now = getTimestampMs();
	local packet = eris_ecm_ping:new();
	if now and packet then
		packet.steamID = eris_ecm_client.steamID;
		packet.client_now = now;
		sendClientCommand("eris_ecm_server", "ping", packet);
	end;
end

----------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------

eris_ecm_client.pong = function(_packet)
	local now = getTimestampMs();
	if now and _packet then
		if _packet.steamID == eris_ecm_client.steamID then
			_packet.stc = now - _packet.server_now;
			_packet.rtt = now - _packet.client_now;
			eris_ecm_client.packet = _packet;
			eris_ecm_client.lastPing = now;
		end;
	end;
end

----------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------

eris_ecm_client.onServerCommand = function(_module, _command, _args)
	if _module ~= "eris_ecm_client" then return; end;
	if _command == "pong" then
		if _args then
			eris_ecm_client.pong(_args);
		end;
	end;
end

----------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------

local function init()
	eris_ecm_client.steamID = getCurrentUserSteamID();
	eris_ecm_client.window = eris_ecm_manager:new();
	eris_ecm_client.window:initialise();
end

----------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------

Events.OnGameStart.Add(init);
Events.OnServerCommand.Add(eris_ecm_client.onServerCommand);

----------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------